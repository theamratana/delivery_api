<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Telegram Login Test</title>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    .card { max-width: 760px; margin: 0 auto; border: 1px solid #ddd; border-radius: 8px; padding: 16px; }
    pre { background: #0b1020; color: #e6edf3; padding: 12px; border-radius: 6px; overflow: auto; }
    .muted { color: #666; }
    .row { margin: 12px 0; }
    label { display:block; font-weight:600; margin-bottom:6px; }
    input[type=text] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    button { padding: 8px 12px; border: 1px solid #444; background: #111; color: #fff; border-radius: 4px; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .hidden { display: none; }
    .stack { display: flex; gap: 8px; flex-wrap: wrap; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Telegram Login â€“ Local/QA Test</h2>
    <p class="muted">Use this page to validate your Telegram Login and get the signed payload (id, first_name, username, auth_date, hash). If you haven't connected yet, you'll be prompted to connect.</p>

    <div class="row">
      <label for="botUser">Bot username (locked)</label>
      <input id="botUser" type="text" value="patience_delivery_bot" readonly />
      <div class="muted">This uses your bot <code>patience_delivery_bot</code>.</div>
    </div>

    <div id="connectRow" class="row hidden">
      <div class="muted" style="margin-bottom:8px">You're not connected yet. Click below to connect with Telegram:</div>
      <div id="widgetMount"></div>
    </div>

    <div class="row">
      <div class="stack">
        <button id="validateBtn">Validate login</button>
        <button id="copyBtn" disabled>Copy JSON to clipboard</button>
      </div>
    </div>

    <h3>Result</h3>
    <pre id="out">{ /* Click Validate login. If you're already connected, your signed payload will appear. Otherwise, you'll be asked to connect. */ }</pre>

    <p class="muted">Next: Paste this JSON into your HTTP client (e.g., Postman) as the request body to <code>POST http://localhost:8081/auth/telegram/verify</code>. Ensure your API is running and <code>TELEGRAM_BOT_TOKEN</code> is set on the server.</p>
  </div>

  <script>
    const mount = document.getElementById('widgetMount');
    const out = document.getElementById('out');
    const copyBtn = document.getElementById('copyBtn');
    const botUserInput = document.getElementById('botUser');
    const validateBtn = document.getElementById('validateBtn');
    const connectRow = document.getElementById('connectRow');

    const DEFAULT_BOT = 'patience_delivery_bot';
    let telegramUser = null;

    function renderWidget() {
      mount.innerHTML = '';
      const botUser = DEFAULT_BOT;

  const s = document.createElement('script');
  s.async = true;
  s.src = 'https://telegram.org/js/telegram-widget.js?22';
  s.dataset.telegramLogin = botUser;
  s.dataset.size = 'large';
  s.dataset.userpic = 'false';
  s.dataset.onauth = 'onTelegramAuth';
  s.dataset.requestAccess = 'write';
  mount.appendChild(s);
    }

    // Telegram widget calls window[onauth] with the user payload.
    // Define handler first, then attach to both globalThis and window (if present).
    const onTelegramAuthHandler = function(user) {
      try {
        // Keep a reference for debugging
        globalThis._lastTelegramUser = user;
        telegramUser = user;
        out.textContent = JSON.stringify(user, null, 2);
        copyBtn.disabled = false;
        connectRow.classList.add('hidden');
      } catch (e) {
        console.error('onTelegramAuth error:', e);
        out.textContent = 'Error handling Telegram payload: ' + e;
      }
    };

    // Attach to the global scope (works in modern browsers)
    globalThis.onTelegramAuth = onTelegramAuthHandler;
    // Also attach to window if available (what the Telegram widget uses under the hood)
    try {
      const w = /** @type {any} */ (globalThis);
      if (w && w.window) {
        w.window['onTelegramAuth'] = onTelegramAuthHandler;
      }
    } catch {}

    // Initial render with default bot. Keep connect section hidden until validation requested.
    renderWidget();

    validateBtn.addEventListener('click', () => {
      if (telegramUser) {
        out.textContent = JSON.stringify(telegramUser, null, 2);
        copyBtn.disabled = false;
        connectRow.classList.add('hidden');
      } else {
        // Reveal the connect area and focus the button
        connectRow.classList.remove('hidden');
        out.textContent = 'Not connected yet. Click the Telegram button above to connect.';
        copyBtn.disabled = true;
      }
    });

    copyBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(out.textContent);
        copyBtn.textContent = 'Copied!';
        setTimeout(() => (copyBtn.textContent = 'Copy JSON to clipboard'), 1200);
      } catch (e) {
        alert('Copy failed: ' + e);
      }
    });
  </script>
</body>
</html>
